name: Emulator Tests

on:
  workflow_dispatch:
  push:
    branches: [ main, feat/** ]

jobs:
  emulator-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test connection to Flutter releases
        run: curl -v "https://storage.googleapis.com/flutter_infra_release/releases/releases_linux.json" 2>&1 | head -50

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Setup JDK 21 (for Firebase emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install firebase-tools
        run: |
          npm install -g firebase-tools

      - name: Initialize Firebase
        run: |
          # Create minimal firebase.json if not exists
          if [ ! -f firebase.json ]; then
            cat > firebase.json << EOF
            {
              "emulators": {
                "firestore": {
                  "port": 8081
                },
                "auth": {
                  "port": 9099
                },
                "ui": {
                  "enabled": true,
                  "port": 8080
                }
              }
            }
            EOF
          fi
          
          # Set up firebase project (demo mode)
          firebase setup:emulators:firestore
          firebase setup:emulators:auth

      - name: Start emulators
        run: |
          # Start emulators with all services your app needs
          firebase emulators:start \
            --only firestore,auth \
            --project demo-test \
            --export-on-exit=./emulator_data \
            --import=./emulator_data &
          
          # Wait for emulator to be fully ready
          sleep 10
          
          # Check if Firestore is responding
          curl -f http://localhost:8081 || exit 1
          echo "Firestore emulator ready"
          
          # Check if Auth is responding (if needed)
          curl -f http://localhost:9099 || echo "Auth emulator might not be needed"
          
        env:
          FIREBASE_CLI_LOGIN: 'false'

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests (emulator)
        env:
          # Use environment variables your app expects
          USE_FIREBASE_EMULATOR: 'true'
          FIRESTORE_EMULATOR_HOST: 'localhost:8081'
          FIREBASE_AUTH_EMULATOR_HOST: 'localhost:9099'
        run: |
          # Give extra time for everything to stabilize
          sleep 5
          flutter test --coverage --exclude-tags=integration -v

      - name: Stop emulators
        if: ${{ always() }}
        run: |
          # Find and kill firebase processes
          pkill -f "firebase emulators" || true
          sleep 3