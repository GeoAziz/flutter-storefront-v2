name: Emulator Tests (DISABLED - Phase 7 Sprint)

on:
  workflow_dispatch:
  # Disabled to unblock Phase 7 Sprint
  # push:
  #   branches: [ main, feat/** ]

jobs:
  emulator-tests:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Test connection to Flutter releases
        run: curl -v "https://storage.googleapis.com/flutter_infra_release/releases/releases_linux.json" 2>&1 | head -50

      - name: Set up Flutter
        uses: subosito/flutter-action@v2
        with:
          flutter-version: '3.24.0'

      - name: Setup JDK 21 (for Firebase emulator)
        uses: actions/setup-java@v4
        with:
          distribution: 'temurin'
          java-version: '21'

      - name: Install firebase-tools
        run: npm install -g firebase-tools

      - name: Start Firestore emulator
        run: |
          firebase emulators:start --only firestore --project=demo-no-project &
          n=0
          until nc -z localhost 8080 || [ $n -gt 30 ]; do
            sleep 1
            n=$((n+1))
          done
        env:
          FIREBASE_CLI_LOGIN: 'false'

      - name: Install dependencies
        run: flutter pub get

      - name: Run tests (emulator)
        env:
          FIREBASE_EMULATOR: 'true'
          FIRESTORE_EMULATOR_HOST: 'localhost:8080'
        run: flutter test --coverage --exclude-tags=integration -v

      - name: Stop emulators
        if: ${{ always() }}
        run: firebase emulators:stop || true