name: Flutter CI

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  analyze_and_test:
    name: Analyze and Test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Flutter (clone stable)
        run: |
          set -euo pipefail
          sudo apt-get update
          sudo apt-get install -y git xz-utils zip unzip curl
          # Clone Flutter stable channel (shallow)
          git clone https://github.com/flutter/flutter.git -b stable --depth 1 /opt/flutter
          echo "/opt/flutter/bin" >> $GITHUB_PATH
          /opt/flutter/bin/flutter --version

      - name: Install dependencies
        run: flutter pub get

      - name: Run analyzer
        run: flutter analyze --no-fatal-infos --no-fatal-warnings

      - name: Run focused pagination tests
        run: |
          # Run explicit pagination-related tests to ensure they are executed
          flutter test test/product_repository_pagination_test.dart test/product_pagination_provider_cursor_test.dart test/product_pagination_provider_invalid_cursor_test.dart -r expanded || true

      - name: Run tests
        run: flutter test --no-pub
